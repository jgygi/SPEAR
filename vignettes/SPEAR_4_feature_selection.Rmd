---
title: "SPEAR: Feature Selection"
author: "Jeremy Gygi"
date: "05/03/21"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{SPEAR_4-feature_selection}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

### This vignette will walk through feature selection using SPEAR

##### Installing SPEAR:

Follow installation instructions in README (located [here](https://github.com/jgygi/SPEAR))

##### Required Libraries:

```{r message = FALSE, warning = FALSE}
library(SPEAR)
```

##### Loading a SPEAR object:

After running SPEAR, you will have saved a SPEARobject (see vignette 2: Running SPEAR).

```{r}
SPEARobj <- readRDS("SPEAR_vignette_object_gaussian.rds")
```

##### Choosing a SPEAR model:

See vignette 3: Downstream Analysis for more information on choosing a SPEARmodel. For this vignette, we will choose the SPEAR model using the default parameters (highest weight within one standard deviation of the lowest overall mean cv error). In this scenario, that ends up being $w = 2$:

```{r}
SPEARmodel <- SPEAR::get_SPEAR_model(SPEARobj)
```

##### Choosing a factor (or factors) of interest

See vignette 3: Downstream Analysis for information on how to analyze the individual factors generated by SPEAR.

For the purposes of this vignette, we will look at which factors are pertinent to prediction of the categorical response. We will add a custom `groups` parameter to the `SPEAR.plot_factor_scores` function:

```{r fig.width = 9, fig.height = 3}
# Get the values we want to plot for the x axis:
custom.groups <- SPEARmodel$data$Y
# Set the names of the custom.groups vector to be the samples they correspond to (can use rownames):
names(custom.groups) <- rownames(SPEARmodel$data$Y)

SPEAR::SPEAR.plot_factor_scores(SPEARmodel, groups = custom.groups) +
  ggplot2::scale_fill_gradient2(low = "dark blue", mid = "purple", high = "dark red")
```

It looks like Factor 1 and Factor 2 are the is the most correlated with our response. We will look into the best features for Factor 1.

### Getting a feature table

##### Get ALL features

```{r warning = FALSE}
# This function will return all features for the requested factors and omics that meet the thresholds set by the coefficient.cutoff and probability.cutoff parameters.
#      factors: which factors are being analyzed? Defaults to all factors, but examples include: 1, c(1, 2, 3), c(1, 4)
#      omics: which omics should features be returned for? Defaults to all omics, but can specify omics based on their names
#      coefficient.cutoff: sets the minimum absolute magnitude of contribution for a feature. Defaults to .01
#      probability.cutoff: sets the minimum posterior selection probability for a feature. Defaults to .5
#      method: how to calculate the in.sample and out.of.sample correlation? Defaults to 'spearman'

# If you want ALL features for ALL omics for a specific factor, set the cutoff parameters to 0:
feature.table.all <- SPEAR::SPEAR.get_feature_table(SPEARmodel, factors = 1, coefficient.cutoff = 0, probability.cutoff = 0)
head(feature.table.all)
```

##### Get SOME features

What if we want to pick the 50 best features for a particular factor? Should we choose the overall highest magnitude coefficients? Or first subset by the highest posterior selection probability?

+ **Coefficient**: useful for finding *different* sources of variation amongst features. However, this may ignore potentially useful features that are correlated with one another (useful for downstream biological interpretation)

+ **Probability**: useful for finding *highly correlated* features. However, there may be different features with higher coefficients with slightly lower probabilities that are contributing to the factor score.

Here we will show an example of the top 50 features selected by each of these methods.

###### By coefficient:

```{r fig.width = 8, fig.height = 8, warning=FALSE}
feature.table.coefficient <- dplyr::arrange(feature.table.all, -abs(Coefficient))[1:50,]
SPEAR::SPEAR.plot_feature_correlation(SPEARmodel, feature.table.coefficient, show.feature.names = TRUE)
```

###### By probability, and then coefficient:

```{r fig.width = 8, fig.height = 8, warning=FALSE}
feature.table.probability <- dplyr::arrange(feature.table.all, -Probability, -abs(Coefficient))[1:50,]
SPEAR::SPEAR.plot_feature_correlation(SPEARmodel, feature.table.probability, show.feature.names = TRUE)
```

##### Get features by desired variance explained:

```{r}
best.features = SPEAR::SPEAR.get_best_features(SPEARmodel, factor = 1, var.cutoff = .5)
```

```{r}
SPEAR.plot_variance_per_feature(SPEARmodel, factor = 1, num.features = 25, probability.cutoff = .5, coefficient.cutoff = .01)
```


