---
title: "SPEAR: Simulating Data"
author: "Jeremy Gygi"
date: "1/26/21"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{SPEAR-simulate_data}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

### This vignette sets up simulated omics data for use with SPEAR. Once generated, this data can be used in the SPEAR_vignette.Rmd file.

### 1. Installation / Libraries

##### Installing SPEAR:

```{r}
# Set up the path to the downladed tar.gz package:
#path_to_SPEAR_tar.gz <- "~/Dropbox/shared_folder/SPEARcomplete_1.0.tar.gz"

# Run this command to install the SPEARcomplete (SPEAR) package
#install.packages(path_to_SPEAR_tar.gz, repos = NULL, type="source")

# If this fails, you may need to install these packages:
#install.packages('BH')
#install.packages('Rcpp')
#install.packages('RcppArmadillo')
#install.packages('glmnet')
```

##### Required Libraries:

```{r}
# Required Packages for SPEAR:
library(SPEARcomplete)
library(glmnet)
library(parallel)

# Seed: (for reproducibility)
seed <- 123
```

### 2. Preprocessing / Running SPEAR

To use SPEAR on multi-omic data, we first need to set up the data to be SPEAR-friendly. For this example, we will simulate 100 subjects with 4 omic datasets, each with 100 features each and a gaussian response. These will be generated by 5 simulated underlying factors:

```{r, echo = FALSE}
# Function to simulate gaussian data (feel free to minimize this chunk after running it once)

dataGen <- function(N = 500, Ntest = 2000, P = 500, D = 4, iteration = NULL, seed = 123, num_factors = 5, c = 1, 
                    pi = 0.2, eta = 1, num_specific =D-2, Ymodel = "factor", family = 0, factors.influencing.y = 2,
                    pi_reg = 0.05){
  
  set.seed(seed)
  Theta0 = list(); Gamma0 = list()
  X = list(); Xte = list()
  for(d in 1:D){
    Theta0[[d]] = matrix(rnorm(P*num_factors, sd = 1), ncol = P) * c
    Gamma0[[d]] = matrix(rbinom(P*num_factors, size = 1, prob  = pi), ncol = P)
  }
  if(num_specific != D){
    print("Assigning factors to datasets:")
    for(k in 1:num_factors){
      ii = sample(1:D, num_specific)
      print(paste0("Factor", k, ": ", paste(ii, collapse = ", ")))
      for(d in 1:D){
        if(!(d%in%ii)){
          Gamma0[[d]][k,] = 0
          Theta0[[d]] = Theta0[[d]] * Gamma0[[d]]
        }
      }
    }
  }
  U0 = matrix(rnorm(N*num_factors), nrow = N)
  U0te = matrix(rnorm(Ntest*num_factors), nrow = Ntest)
  X = list(); Xte = list()
  scale_mean.X = c(); scale_sd.X = c()
  for(d in 1:D){
    X[[d]] = scale(U0 %*% Theta0[[d]]+matrix(rnorm(N*P), ncol = P))
    Xte[[d]] = scale(U0te %*% Theta0[[d]]+matrix(rnorm(Ntest*P), ncol = P))
    tmp1 = apply(X[[d]], 2, mean);
    tmp2 =  apply(X[[d]], 2, sd);
    scale_mean.X =c(scale_mean.X, tmp1)
    scale_sd.X = c(scale_sd.X, tmp2)
    X[[d]] = t(apply(X[[d]], 1, function(z) (z - tmp1)/tmp2))
    Xte[[d]] = t(apply(Xte[[d]], 1, function(z) (z - tmp1)/tmp2))
  }
  if(Ymodel == "factor"){
    Y = rowSums(U0[,1:factors.influencing.y])*sqrt(eta/factors.influencing.y) + rnorm(N)
    Yte = rowSums(U0te[,1:factors.influencing.y])* sqrt(eta/factors.influencing.y)+rnorm(Ntest)
    Ytruth = rowSums(U0[,1:factors.influencing.y])*sqrt(eta/factors.influencing.y)
    Ytruth_te =  rowSums(U0te[,1:factors.influencing.y])* sqrt(eta/factors.influencing.y)
  }else{
    Xcombine = X[[1]]
    Xcombine.te = Xte[[1]]
    for(d in 2:D){
      Xcombine = cbind(Xcombine, X[[d]])
      Xcombine.te = cbind(Xcombine.te, Xte[[d]])
    }
    beta =rnorm(ncol(Xcombine)) * rbinom(ncol(Xcombine), size = 1, prob = pi_reg) 
    beta = beta/sqrt(sum(beta^2)) * sqrt(eta)
    Ytruth =  Xcombine%*%beta
    Ytruth_te =  Xcombine.te%*% beta
    Y = Ytruth + rnorm(N)
    Yte = Ytruth_te+rnorm(Ntest)
  }
  scale_mean.y = mean(Y); scale_sd.y = sd(Y);
  y = (Y - scale_mean.y)/scale_sd.y; yte = (Yte - scale_mean.y)/scale_sd.y;
  ytruth = (Ytruth - scale_mean.y)/scale_sd.y; ytruth.te = (Ytruth_te - scale_mean.y)/scale_sd.y;
  data.tr = preparation(Y = y, X = X, family = family, path.type = "assay")
  data.te = preparation(Y = yte, X = Xte, family = family, path.type = "assay")
  data.tr$truth = ytruth
  data.tr$xlist = X
  data.tr$U = U0
  data.te$truth = ytruth.te
  data.te$U = U0te
  data.te$xlist = Xte
  return(list(data.tr = data.tr, data.te = data.te))
}
```

##### Getting Simulated Data:

```{r}
# Data simulation parameters:
K = 5 # number of factors
D = 4 # number of omics datasets to simulate
N = 200 # number of subjects in the training set
P = 200 # number of features to simulate per omics dataset
c = 3 # signal-to-noise ratio. 1 is low, 3 is high
c = sqrt(c *log(P*D)/N) 
Ymodel = "factor" # parameter indicating that Y (gaussian response) is generated from the factors
Ntest = 2000 # number of subjects in the testing set
num_specific = 2 # should factors be omics specific? If num_specific = D, all omics are influenced by all factors. If num_specific < D, each factor will be randomly assigned to 'num_specific' omics datasets.
factors.influencing.y = 2 # how many of the K factors should be used to influence the response?
family = 0 # When response is gaussian, use family = 0. For ordinal response, use family = 1
pi = .2 # amount of sparsity for features (P(feature having signal) = pi)

# Data Generation:
data.total = dataGen(N = N, 
               Ntest = Ntest, 
               P = P, 
               D = D, 
               iteration = NULL, 
               seed = seed, 
               num_factors = K, 
               c = c, 
               pi = pi, 
               eta = 1, 
               num_specific =num_specific, 
               Ymodel = Ymodel,
               family = family,
               factors.influencing.y = factors.influencing.y,
               pi_reg = N/(P*D*log(P * D) * log(P * D)))


# Save the data to use in the SPEAR vignette:
file_path <- getwd()
saveRDS(data.total, file = paste0(file_path, "/simulated_gaussian_data.rds"))
```

The simulated data are stored as an rds file. You can load it into the SPEAR_vignette.Rmd file to use it with SPEAR.
